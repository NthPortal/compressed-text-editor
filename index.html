<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Paste</title>

    <!-- fonts -->
    <link href="https://fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Mono" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- un-minified, for dev -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.js"
            integrity="sha384-p7RDedFtQzvcp0/3247fDud39nqze/MUmahi6MOWjyr3WKWaMOyqhXuCT1sM9Q+l"
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.28.0/codemirror.js"
            integrity="sha384-2oQeExpmhgj6uQgAGccG9DbAjLdoaNsfWwfnEWyiu/SCuhmdT5f0gT1j+8uwOTTz"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.28.0/codemirror.css"
          integrity="sha384-MD6zhovZ9zyNUpx2FepMO8dm88ZMFqKfLt+s/Us+6uy4dHM8oyPvRZj0boMmc4uK" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.css"
          integrity="sha384-DcAdi7yEKpncv9cGw54ekvrKgGf0Z7mzzsJlIaiTyvPuMNskkFN1fXyA6QV5/e6U" crossorigin="anonymous">

    <!-- minified -->
    <!--
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"
                integrity="sha384-xBuQ/xzmlsLoJpyjoggmTEz8OWUFM0/RC5BsqQBDX2v5cMvDHcMakNTNrHIW2I5f"
                crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.28.0/codemirror.min.js"
                integrity="sha384-ggIz/g4n/xqUxjulFlRcuVxkmj2mmH1tQl0ED7ChsOps2ZaJhnR71Trp38MXDqQu"
                crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.28.0/codemirror.min.css"
              integrity="sha384-yrO23ics6kDWPetsnqRPPUa9AmFW2JzwBpTjnqHGux46qnEK6RYpsN38ZQarvqnP" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.min.css"
              integrity="sha384-YzEqZ2pBV0i9OmlTyoz75PqwTR8If8GsXBv7HLQclEVqIC3VxIt98/U94ES6CJTR" crossorigin="anonymous">
    -->

    <link rel="stylesheet" href="css/main.css">

    <script type="text/javascript">
        var lightDarkStyleKey = "editor-style";
        var styleDark = "dark";
        var styleLight = "light";

        function getLightDarkStyle() {
            var style = window.localStorage.getItem(lightDarkStyleKey);
            if (style === styleLight) {
                return styleLight;
            } else {
                return styleDark;
            }
        }

        function deleteOldStyle() {
            var prev = $("#style-link")[0];
            if (prev !== null && prev !== undefined) {
                prev.remove();
            }
        }

        function setStyleDark() {
            window.localStorage.setItem(lightDarkStyleKey, styleDark);
            deleteOldStyle();
            $('head').append('<link id="style-link" rel="stylesheet" href="css/style-dark.css">');
        }

        function setStyleLight() {
            window.localStorage.setItem(lightDarkStyleKey, styleLight);
            deleteOldStyle();
            $('head').append('<link id="style-link" rel="stylesheet" href="css/style-light.css">');
        }

        if (getLightDarkStyle() === styleDark) {
            setStyleDark();
        } else {
            setStyleLight();
        }
    </script>
</head>
<body>
<div id="help-modal" class="modal-container">
    <div class="modal-contents">
        <div class="modal-header">
            <button id="help-modal-close" class="button button-trans modal-close">
                <i class="material-icons">close</i>
            </button>
            <h2>Help</h2>
        </div>
        <hr>
        <div class="modal-body">
            <p>Click <i class="material-icons small-icon">invert_colors</i> to switch between light and dark themes</p>
            <p>Click <i class="material-icons small-icon">delete</i> with an empty editor to clear history</p>
            <p><kbd>Ctrl</kbd>+<kbd>S</kbd> / <kbd>Cmd</kbd>+<kbd>S</kbd> to save</p>
            <p>Drag and drop a file into the editor to load it</p>
            <br>
            <h3>About</h3>
            <p>This site stores paste data in the URL.
                As such, a URL <b><i>permanently</i></b> stores a paste's contents.</p>
            <p>Consequently, if a paste contains sensitive information,
                one should not create a shortened link for it.</p>
        </div>
    </div>
</div>

<div id="settings-modal" class="modal-container">
    <div class="modal-contents">
        <div class="modal-header">
            <button id="settings-modal-close" class="button button-trans modal-close">
                <i class="material-icons">close</i>
            </button>
            <h2>Settings</h2>
        </div>
        <hr>
        <div class="modal-body">
            <label for="settings-link-shortener" class="setting-label">Link Shortener (URL)</label>
            <input id="settings-link-shortener" type="url" title="Link Shortener" placeholder="https://..."
                   class="setting-text-input">
        </div>
        <div class="modal-footer">
            <button id="settings-save" class="button"><i class="material-icons">save</i></button>
        </div>
    </div>
</div>

<div class="toolbar">
    <button id="copy-link" title="Copy Link" class="button"><i class="material-icons">link</i></button>
    <button id="undo" title="Undo" class="button button-trans"><i class="material-icons">undo</i></button>
    <button id="redo" title="Redo" class="button button-trans"><i class="material-icons">redo</i></button>
    <button id="toggle-light-dark" title="Toggle Theme" class="button button-trans">
        <i class="material-icons">invert_colors</i>
    </button>
    <button id="settings" title="Settings" class="button button-trans"><i class="material-icons">settings</i></button>
    <button id="help" title="Help" class="button button-trans"><i class="material-icons">help</i></button>
    <button id="clear-text" title="Clear" class="button"><i class="material-icons">delete</i></button>
</div>

<div id="text">
    <textarea id="editor" title="Editor"></textarea>
</div>

<script type="text/javascript">
    var editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
        lineNumbers: true,
        lineWrapping: true
    });

    editor.focus();
</script>

<!-- un-minified, for dev -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.js"
        integrity="sha384-ph76mR0W+Z/3+JTfCgW7I+2WZrKUE1M2EabdJVneuKwpssRuQggPhzQJ3oDectWZ"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.5/pako.js"
        integrity="sha384-BYYNVB6PTbWOzQgdLKvftcjRcmgC6cej4edRR++cv1NJdPznWxt8mGSHAH8aBBvG"
        crossorigin="anonymous"></script>

<!-- minified -->
<!--
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"
        integrity="sha384-VgWGwiEJnh9P379lbU8DxPcfRuFkfLl0uPuL9tolOHtm2tx8Qy8d/KtvovfM0Udh"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.5/pako.min.js"
        integrity="sha384-OSzzM3DXyHXdOPYsZJlqCEXk9SoX56oWNhSq48Zn8qoV3NJoByQsNWlspDLuwYOW"
        crossorigin="anonymous"></script>
-->

<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.3/toastr.min.js"
        integrity="sha384-VDls8ImYGI8SwVxpmjX2Bn27U2TcNodzTNROTusVEWO55+lmL+H9NczoQJk6mwZR"
        crossorigin="anonymous"></script>

<script type="text/javascript">
    var settingsModal = $("#settings-modal");
    var linkShortenerSetting = $("#settings-link-shortener");
    var linkShortenerKey = "paste-setting-link-shortener";
    var defaultLinkShortener = null; // Set to an appropriate link shortener URL if desired
    var linkShortener = defaultLinkShortener;

    var helpModal = $("#help-modal");
    var storeTextToURLTimeout;
    var deflateOpts = {to: 'string'};

    /* misc functions */
    function saveText() {
        var blob = new Blob([editor.getValue()], {type: "text/plain;charset=utf-8"});
        saveAs(blob, "untitled.txt");
        editor.focus();
    }

    function showHelp() {
        helpModal[0].style.display = "block";
    }

    function hideHelp() {
        helpModal[0].style.display = "none";
        editor.focus();
    }

    function loadSettings() {
        var shortener = window.localStorage.getItem(linkShortenerKey);
        if (shortener === null) {
            shortener = defaultLinkShortener;
        }
        linkShortener = shortener;
        linkShortenerSetting.val(linkShortener);
    }

    function saveSettings() {
        linkShortener = linkShortenerSetting.val().trim();
        window.localStorage.setItem(linkShortenerKey, linkShortener);
        hideSettings();
    }

    function showSettings() {
        settingsModal[0].style.display = "block";
    }

    function hideSettings() {
        settingsModal[0].style.display = "none";
        loadSettings();
        editor.focus();
    }

    function doUndo() {
        editor.undo();
        editor.focus();
    }

    function doRedo() {
        editor.redo();
        editor.focus();
    }

    function clearText() {
        if (editor.getValue() !== "") {
            editor.setValue("");
        } else {
            editor.clearHistory();
            var h = window.location.hash;
            if (h !== "") {
                window.location.hash = '';
            }
        }
        editor.focus();
    }

    function loadTextFromURL() {
        var h = window.location.hash;
        if (h !== "" && h !== "#") {
            var loadingToast = null;
            var loadingTimeout = setTimeout(function () {
                loadingToast = toastr.info("Loading text...");
            }, 5);
            try {
                editor.setValue(pako.inflateRaw(atob(h.slice(1)), deflateOpts));
            } catch (err) {
                console.error(err);
                toastr.error("See console for details", "Error loading text");
            }
            clearTimeout(loadingTimeout);
            if (loadingToast !== null) {
                toastr.clear(loadingToast);
            }
        }
    }

    function storeTextToURL() {
        var text = editor.getValue();
        if (text !== '') {
            var compressed = pako.deflateRaw(editor.getValue(), deflateOpts);
            window.location.hash = btoa(compressed);
        } else {
            window.location.hash = '';
        }
    }

    function maybeOpenLinkShortener() {
        if (linkShortener !== null && linkShortener !== "") {
            window.open(linkShortener, "_blank");
        }
    }

    function copyLink() {
        storeTextToURL();
        if (document.queryCommandSupported('copy')) {
            var textArea = document.createElement("textarea");
            textArea.style.position = 'fixed';
            textArea.style.zIndex = -1;
            textArea.value = window.location.href;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            toastr.success("Copied link to clipboard");
            setTimeout(maybeOpenLinkShortener, 1000)
        } else {
            if (prompt('Copy the URL, then click "OK".', window.location.href)) {
                maybeOpenLinkShortener();
            }
        }
        editor.focus();
    }

    function updateURL() {
        clearTimeout(storeTextToURLTimeout);
        storeTextToURLTimeout = setTimeout(storeTextToURL, 1000);
    }

    function toggleLightDarkStyle() {
        if (getLightDarkStyle() === styleLight) {
            setStyleDark();
        } else {
            setStyleLight();
        }
        editor.focus();
    }

    /* handle click events */
    $("#copy-link").click(copyLink);
    $("#toggle-light-dark").click(toggleLightDarkStyle);
    $("#undo").click(doUndo);
    $("#redo").click(doRedo);
    $("#clear-text").click(clearText);

    $("#settings").click(showSettings);
    $("#settings-modal-close").click(hideSettings);
    $("#settings-save").click(saveSettings);
    $("#help").click(showHelp);
    $("#help-modal-close").click(hideHelp);

    /* store data on editor update */
    editor.on('change', updateURL);

    /* capture Ctrl+S */
    document.addEventListener('keydown', function (event) {
        if ((event.keyCode === 115 || event.keyCode === 83) && (event.ctrlKey || event.metaKey)) {
            saveText();
            event.preventDefault();
            return false;
        } else {
            return true;
        }
    });

    /* capture dropped file */
    document.addEventListener('drop', function (event) {
        event.preventDefault();
        event.stopPropagation();

        var reader = new FileReader();
        reader.onload = function () {
            editor.setValue(reader.result);
        };
        reader.readAsText(event.dataTransfer.files[0]);
    });

    /* Hide modals when clicking outside of them */
    window.onclick = function (event) {
        if (event.target === helpModal[0]) {
            hideHelp();
        } else if (event.target === settingsModal[0]) {
            hideSettings();
        }
    };

    /* set toastr options */
    toastr.options = {
        "closeButton": false,
        "debug": false,
        "newestOnTop": false,
        "progressBar": false,
        "positionClass": "toast-top-right",
        "preventDuplicates": false,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "300",
        "timeOut": "5000",
        "extendedTimeOut": "5000",
        "showEasing": "linear",
        "hideEasing": "linear",
        "showMethod": "slideDown",
        "hideMethod": "slideUp"
    };

    /* load stuff */
    loadSettings();
    loadTextFromURL();
</script>
</body>
</html>
